services:
  client:
    image: skyface753/cronitor-client:latest
    build:
      context: client-react
      dockerfile: Dockerfile
    networks:
      - cronitor
    environment:
      TZ: Europe/Berlin
      NODE_ENV: production
    volumes:
      - ./jobs.json:/jobs.json

  server:
    image: skyface753/cronitor-server:latest
    build:
      context: server
      dockerfile: Dockerfile
    ports:
      - '127.0.0.1:8000:8000'
    networks:
      - cronitor
    environment:
      TZ: Europe/Berlin
      APIKEY: ${APIKEY}
      MAIL_DISABLED: ${MAIL_DISABLED}
      MONGODB_CONNECTION_URI: ${MONGODB_CONNECTION_URI}
      DB_NAME: ${DB_NAME}
      COLL_NAME: ${COLL_NAME}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_TO: ${SMTP_TO}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
    depends_on:
      - mongodb
    volumes:
      - ./jobs.json:/jobs.json

  proxy:
    image: skyface753/cronitor-proxy:latest
    build:
      context: ./proxy
      dockerfile: Dockerfile
    networks:
      - cronitor
      - proxy
    restart: always
    environment:
      TZ: Europe/Berlin
    depends_on:
      - server
      - client
    labels:
      - 'traefik.enable=true' #<== Enable traefik
      - 'traefik.http.routers.cronitor-secured.rule=Host(`cronitor.skyface.de`)' #<== Set domain
      - 'traefik.http.routers.cronitor-secured.entrypoints=websecure' #<== Set entry point for HTTPS
      - 'traefik.http.routers.cronitor-secured.tls.certresolver=mytlschallenge' #<== Set certsresolvers for https
      - 'traefik.http.routers.cronitor-secured.middlewares=authelia'
      - 'traefik.http.routers.cronitor-secured.service=cronitor-service' #<== Set service
      - 'traefik.http.services.cronitor-service.loadbalancer.server.port=80' #<== Set port

  mongodb:
    image: mongo:latest
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    volumes:
      - ./data:/data/db
    networks:
      - cronitor
    environment:
      TZ: Europe/Berlin
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin
    healthcheck:
      test: 'curl -f http://localhost:27017'
      interval: 5s
      timeout: 10s
      retries: 5

networks:
  proxy:
    external: true
  cronitor:
    driver: bridge
